'use strict';function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new Promise(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(a){return void c(a)}return g.done?void a(h):Promise.resolve(h).then(function(a){d('next',a)},function(a){d('throw',a)})}return d('next')})}}require('babel-polyfill');var keeper=require('./mongodb-interface.js'),path=require('path'),express=require('express'),app=express(),expressWs=require('express-ws')(app),timeout=6e5;_asyncToGenerator(regeneratorRuntime.mark(function a(){var b,c;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,keeper.getCollection();case 2:return b=a.sent,a.next=5,keeper.recovery(b[0]);case 5:return c=a.sent,c||(c=keeper.createTree(keeper.MongodbTreeNode,b[0])),a.abrupt('return',[c,b[1]]);case 8:case'end':return a.stop();}},a,void 0)}))().then(function(a){function b(){var a=!0,b=!1,c=void 0;try{for(var d,e,f=arguments[Symbol.iterator]();!(a=(d=f.next()).done);a=!0)if(e=d.value,'number'!=typeof e)return!1}catch(a){b=!0,c=a}finally{try{!a&&f.return&&f.return()}finally{if(b)throw c}}return!0}var c=a[0];process.on('exit',a[1]),app.get('/',function(a,b){b.sendFile('index.html',{root:__dirname})});var d=new Set([]);app.ws('/',function(a){a.refreshTime=Date.now(),d.add(a),a.on('message',function(e){try{var f=JSON.parse(e);if(b(f.time)){if(b(f.x1,f.y1,f.x2,f.y2,f.time))a.refreshTime=Date.now(),c.query(f.x1,f.y1,f.x2,f.y2,f.time).then(function(b){a.send(JSON.stringify(b))});else throw'Error Data';}else if(b(f[0].x,f[0].y,f[1].r,f[1].g,f[1].b,f[2])){a.refreshTime=Date.now();var g=Date.now();c.addPoint(f[0],f[1],g);var h=JSON.stringify([{x:f[0].x,y:f[0].y,r:f[1].r,g:f[1].g,b:f[1].b,t:g,abandoned:!1}]),j=!0,k=!1,l=void 0;try{for(var m,n,i=d[Symbol.iterator]();!(j=(m=i.next()).done);j=!0){n=m.value;try{g-n.refreshTime>timeout?(d.delete(n),n.close()):n.send(h)}catch(a){console.log(a),d.delete(n),n.close()}}}catch(a){k=!0,l=a}finally{try{!j&&i.return&&i.return()}finally{if(k)throw l}}}else throw'Error Data'}catch(b){console.log(b),d.delete(a),a.close()}})}),app.listen(3e3,function(){return console.log('Example app listening on port 3000!')})});