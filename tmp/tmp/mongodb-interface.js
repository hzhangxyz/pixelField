'use strict';var _createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,'value'in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}(),getCollection=function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){var b,c,d,e=this;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,MongoClient.connect(url);case 2:return b=a.sent,c=b.db(dbName),d=c.collection('tree'),a.abrupt('return',[d,_asyncToGenerator(regeneratorRuntime.mark(function a(){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,b.close();case 2:return a.abrupt('return',a.sent);case 3:case'end':return a.stop();}},a,e)}))]);case 6:case'end':return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}(),recovery=function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b,c){var d,e,f,g,h,j,k,l,m,i,n,o,p,q;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,b.find({},{projection:{data:0}}).toArray();case 2:for(d=a.sent,e={},f=d.map(function(a){var c=new MongodbTreeNode(a.x1,a.y1,a.x2,a.y2,null,b);return c.id=a._id,c._father=a.father,c._leftSon=a.leftSon,c._rightSon=a.rightSon,e[c.id]=c,c}),g=!0,h=!1,j=void 0,a.prev=8,k=f[Symbol.iterator]();!(g=(l=k.next()).done);g=!0)m=l.value,m._father&&(m.father=e[m._father]),m._leftSon&&(m.leftSon=e[m._leftSon]),m._rightSon&&(m.rightSon=e[m._rightSon]),delete m._father,delete m._leftSon,delete m._rightSon;a.next=16;break;case 12:a.prev=12,a.t0=a['catch'](8),h=!0,j=a.t0;case 16:a.prev=16,a.prev=17,!g&&k.return&&k.return();case 19:if(a.prev=19,!h){a.next=22;break}throw j;case 22:return a.finish(19);case 23:return a.finish(16);case 24:if(0!=f.length){a.next=28;break}return a.abrupt('return',null);case 28:if(!c){a.next=60;break}i=!0,n=!1,o=void 0,a.prev=32,p=f[Symbol.iterator]();case 34:if(i=(q=p.next()).done){a.next=43;break}if(m=q.value,m.id!=c){a.next=40;break}return a.next=39,m.findAncestor();case 39:return a.abrupt('return',a.sent);case 40:i=!0,a.next=34;break;case 43:a.next=49;break;case 45:a.prev=45,a.t1=a['catch'](32),n=!0,o=a.t1;case 49:a.prev=49,a.prev=50,!i&&p.return&&p.return();case 52:if(a.prev=52,!n){a.next=55;break}throw o;case 55:return a.finish(52);case 56:return a.finish(49);case 57:return a.abrupt('return',null);case 60:return a.next=62,f[0].findAncestor();case 62:return a.abrupt('return',a.sent);case 63:case'end':return a.stop();}},a,this,[[8,12,16,24],[17,,19,23],[32,45,49,57],[50,,52,56]])}));return function(){return a.apply(this,arguments)}}();function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')}function _possibleConstructorReturn(a,b){if(!a)throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called');return b&&('object'==typeof b||'function'==typeof b)?b:a}function _inherits(a,b){if('function'!=typeof b&&null!==b)throw new TypeError('Super expression must either be null or a function, not '+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new Promise(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(a){return void c(a)}return g.done?void a(h):Promise.resolve(h).then(function(a){d('next',a)},function(a){d('throw',a)})}return d('next')})}}require('babel-polyfill');var MongoClient=require('mongodb').MongoClient,commonInterface=require('./common-interface.js'),url='mongodb://localhost:27017',dbName='pixelField',MongodbTreeNode=function(a){function b(){return _classCallCheck(this,b),_possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).apply(this,arguments))}return _inherits(b,a),_createClass(b,[{key:'init',value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){var b,c;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(!this.inited){a.next=2;break}return a.abrupt('return');case 2:if(!this.id){a.next=9;break}return a.next=5,this.collection.findOne({_id:this.id});case 5:b=a.sent,this.data=b.data,a.next=13;break;case 9:return a.next=11,this.collection.insertOne({x1:this.x1,y1:this.y1,x2:this.x2,y2:this.y2,flag:this.flag,data:this.data,father:this.getId(this.father),leftSon:this.getId(this.leftSon),rightSon:this.getId(this.rightSon)});case 11:c=a.sent,this.id=c.ops[0]._id;case 13:this.inited=!0;case 14:case'end':return a.stop();}},a,this)}));return function init(){return a.apply(this,arguments)}}()},{key:'disinit',value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:delete this.data,this.data=[],this.inited=!1;case 3:case'end':return a.stop();}},a,this)}));return function disinit(){return a.apply(this,arguments)}}()},{key:'getId',value:function getId(a){return a?a.id?a.id:null:null}},{key:'save_node',value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this.collection.updateOne({_id:this.id},{$set:{father:this.getId(this.father),leftSon:this.getId(this.leftSon),rightSon:this.getId(this.rightSon)}});case 2:case'end':return a.stop();}},a,this)}));return function save_node(){return a.apply(this,arguments)}}()},{key:'timeLinePointConverter',value:function timeLinePointConverter(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:!0;return this.data[a].abandoned&&b?{abandoned:!0}:{x:this.data[a].x,y:this.data[a].y,r:this.data[a].r,g:this.data[a].g,b:this.data[a].b,t:this.data[a].t,abandoned:this.data[a].abandoned}}},{key:'save_point',value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){var b,c,d,e,f,g,h;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(0==this.dataModified.length){a.next=24;break}for(b={},c=!0,d=!1,e=void 0,a.prev=5,f=this.dataModified[Symbol.iterator]();!(c=(g=f.next()).done);c=!0)h=g.value,b['data.'+h]=this.timeLinePointConverter(h);a.next=13;break;case 9:a.prev=9,a.t0=a['catch'](5),d=!0,e=a.t0;case 13:a.prev=13,a.prev=14,!c&&f.return&&f.return();case 16:if(a.prev=16,!d){a.next=19;break}throw e;case 19:return a.finish(16);case 20:return a.finish(13);case 21:return this.dataModified=[],a.next=24,this.collection.updateOne({_id:this.id},{$set:b});case 24:return a.next=26,this.collection.updateOne({_id:this.id},{$push:{data:this.timeLinePointConverter(this.data.length-1)}});case 26:case'end':return a.stop();}},a,this,[[5,9,13,21],[14,,16,20]])}));return function save_point(){return a.apply(this,arguments)}}()},{key:'save_fresh',value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this.collection.updateOne({_id:this.id},{$pull:{data:{abandoned:!0}}},{multi:!0});case 2:case'end':return a.stop();}},a,this)}));return function save_fresh(){return a.apply(this,arguments)}}()},{key:'freshAll',value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this.collection.update({},{$pull:{data:{abandoned:!0}}},{multi:!0});case 2:return a.next=4,this._freshAll();case 4:case'end':return a.stop();}},a,this)}));return function freshAll(){return a.apply(this,arguments)}}()},{key:'_freshAll',value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(!this.father){a.next=5;break}return a.next=3,this.father._freshAll();case 3:a.next=7;break;case 5:return a.next=7,this.__freshAll();case 7:case'end':return a.stop();}},a,this)}));return function _freshAll(){return a.apply(this,arguments)}}()},{key:'__freshAll',value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function c(){var d,a;return regeneratorRuntime.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return this.leftSon&&(d=this.leftSon.__freshAll()),this.rightSon&&(a=this.rightSon.__freshAll()),b.next=4,this.disinit();case 4:return b.next=6,this.init();case 6:if(!this.leftSon){b.next=9;break}return b.next=9,d;case 9:if(!this.rightSon){b.next=12;break}return b.next=12,a;case 12:case'end':return b.stop();}},c,this)}));return function __freshAll(){return a.apply(this,arguments)}}()}]),b}(commonInterface.TreeNode);module.exports={getCollection:getCollection,recovery:recovery,MongodbTreeNode:MongodbTreeNode,edgeSize:commonInterface.edgeSize,createTree:commonInterface.createTree};