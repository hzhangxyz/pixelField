"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_slicedToArray=function(){function a(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!(b&&c.length===b));d=!0);}catch(a){e=!0,f=a}finally{try{!d&&h["return"]&&h["return"]()}finally{if(e)throw f}}return c}return function(b,c){if(Array.isArray(b))return b;if(Symbol.iterator in Object(b))return a(b,c);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();function _possibleConstructorReturn(a,b){if(!a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return b&&("object"==typeof b||"function"==typeof b)?b:a}function _inherits(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function, not "+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)}function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new Promise(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(a){return void c(a)}return g.done?void a(h):Promise.resolve(h).then(function(a){d("next",a)},function(a){d("throw",a)})}return d("next")})}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}require("babel-polyfill");var edgeSize=128,TimeLine=function(){function a(){_classCallCheck(this,a),this.data=[],this.inited=!1}return _createClass(a,[{key:"__addPoint",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b,c,d){var e;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:for(this.dataModified=[],this.data.push({x:b.x,y:b.y,r:c.r,g:c.g,b:c.b,t:d,abandoned:!1}),e=0;e<this.data.length-1;e++)this.data[e]&&this.data[e].x==b.x&&this.data[e].y==b.y&&(this.data[e]={abandoned:!0},this.dataModified.push(e));return a.next=5,this.save_point();case 5:case"end":return a.stop();}},a,this)}));return function __addPoint(){return a.apply(this,arguments)}}()},{key:"__query",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){var b,c,d=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:b=[],c=this.data.length-1;case 2:if(!(0<=c)){a.next=11;break}if(!this.data[c].abandoned){a.next=5;break}return a.abrupt("continue",8);case 5:if(b.push(this.data[c]),!(this.data[c].t<=d)){a.next=8;break}return a.abrupt("break",11);case 8:c--,a.next=2;break;case 11:return a.abrupt("return",b);case 12:case"end":return a.stop();}},a,this)}));return function __query(){return a.apply(this,arguments)}}()},{key:"fresh",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){var b,c,d,e,f,g,h;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this.init();case 2:b=[],c=!0,d=!1,e=void 0,a.prev=6,f=this.data[Symbol.iterator]();case 8:if(c=(g=f.next()).done){a.next=16;break}if(h=g.value,!h.abandoned){a.next=12;break}return a.abrupt("continue",13);case 12:b.push(h);case 13:c=!0,a.next=8;break;case 16:a.next=22;break;case 18:a.prev=18,a.t0=a["catch"](6),d=!0,e=a.t0;case 22:a.prev=22,a.prev=23,!c&&f.return&&f.return();case 25:if(a.prev=25,!d){a.next=28;break}throw e;case 28:return a.finish(25);case 29:return a.finish(22);case 30:return delete this.data,this.data=b,a.next=34,this.save_fresh();case 34:case"end":return a.stop();}},a,this,[[6,18,22,30],[23,,25,29]])}));return function fresh(){return a.apply(this,arguments)}}()},{key:"init",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(!this.inited){a.next=2;break}return a.abrupt("return");case 2:this.inited=!0;case 3:case"end":return a.stop();}},a,this)}));return function init(){return a.apply(this,arguments)}}()},{key:"save_node",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:case"end":return a.stop();}},a,this)}));return function save_node(){return a.apply(this,arguments)}}()},{key:"save_point",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:case"end":return a.stop();}},a,this)}));return function save_point(){return a.apply(this,arguments)}}()},{key:"save_fresh",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:case"end":return a.stop();}},a,this)}));return function save_fresh(){return a.apply(this,arguments)}}()}]),a}(),TreeNode=function(a){function b(a,c,d,e,f,g){_classCallCheck(this,b);var h=_possibleConstructorReturn(this,(b.__proto__||Object.getPrototypeOf(b)).call(this));return h.x1=a,h.y1=c,h.x2=d,h.y2=e,h.leftSon=null,h.rightSon=null,h.father=f,h.flag=d-a<=edgeSize-1&&e-c<=edgeSize-1,h.collection=g,h}return _inherits(b,a),_createClass(b,[{key:"format",value:function format(){return"node x1:"+this.x1+", y1:"+this.y1+", x2:"+this.x2+", y2:"+this.y2+" "+(this.flag?"F":"")}},{key:"show",value:function show(){console.log(this.format())}},{key:"whetherInclude",value:function whetherInclude(a){return this.x1<=a.x&&a.x<=this.x2&&this.y1<=a.y&&a.y<=this.y2}},{key:"split",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){var b,c,d,e;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(!(this.flag||this.leftSon)){a.next=2;break}return a.abrupt("return");case 2:return b=this.x1,c=this.x2,d=this.y1,e=this.y2,c-b==e-d?(this.leftSon=this.leftSon||new this.constructor(b,d,c,(d+e+1)/2-1,this,this.collection),this.rightSon=this.rightSon||new this.constructor(b,(d+e+1)/2,c,e,this,this.collection)):(this.leftSon=this.leftSon||new this.constructor(b,d,(b+c+1)/2-1,e,this,this.collection),this.rightSon=this.rightSon||new this.constructor((b+c+1)/2,d,c,e,this,this.collection)),a.next=6,Promise.all([this.leftSon.init(),this.rightSon.init()]);case 6:return a.next=8,this.save_node();case 8:case"end":return a.stop();}},a,this)}));return function split(){return a.apply(this,arguments)}}()},{key:"extend",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){var b,c,d,e;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(!this.father){a.next=2;break}return a.abrupt("return");case 2:return b=this.x1,c=this.x2,d=this.y1,e=this.y2,c-b==e-d?0<c+b?(this.father=new this.constructor(2*b-c-1,d,c,e,null,this.collection),this.father.leftSon=this,this.father.rightSon=new this.constructor(2*b-c-1,d,b-1,e,this.father,this.collection)):(this.father=new this.constructor(b,d,2*c-b+1,e,null,this.collection),this.father.leftSon=this,this.father.rightSon=new this.constructor(c+1,d,2*c-b+1,e,this.father,this.collection)):0<e+d?(this.father=new this.constructor(b,2*d-e-1,c,e,null,this.collection),this.father.leftSon=this,this.father.rightSon=new this.constructor(b,2*d-e-1,c,d-1,this.father,this.collection)):(this.father=new this.constructor(b,d,c,2*e-d+1,null,this.collection),this.father.leftSon=this,this.father.rightSon=new this.constructor(b,e+1,c,2*e-d+1,this.father,this.collection)),a.next=6,Promise.all([this.father.init(),this.father.rightSon.init()]);case 6:return a.next=8,Promise.all([this.save_node(),this.father.save_node(),this.father.rightSon.save_node()]);case 8:case"end":return a.stop();}},a,this)}));return function extend(){return a.apply(this,arguments)}}()},{key:"_addPoint",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b,c,d){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this.init();case 2:if(!this.flag){a.next=7;break}return a.next=5,this.__addPoint(b,c,d);case 5:a.next=16;break;case 7:return a.next=9,this.split();case 9:if(!this.leftSon.whetherInclude(b)){a.next=14;break}return a.next=12,this.leftSon._addPoint(b,c,d);case 12:a.next=16;break;case 14:return a.next=16,this.rightSon._addPoint(b,c,d);case 16:case"end":return a.stop();}},a,this)}));return function _addPoint(){return a.apply(this,arguments)}}()},{key:"addPoint",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b,c,d){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this.init();case 2:if(!this.father){a.next=7;break}return a.next=5,this.father.addPoint(b,c,d);case 5:a.next=16;break;case 7:if(!this.whetherInclude(b)){a.next=12;break}return a.next=10,this._addPoint(b,c,d);case 10:a.next=16;break;case 12:return a.next=14,this.extend();case 14:return a.next=16,this.father.addPoint(b,c,d);case 16:case"end":return a.stop();}},a,this)}));return function addPoint(){return a.apply(this,arguments)}}()},{key:"whetherOverlap",value:function whetherOverlap(a,b,c,d){var e=c>=this.x1&&a<=this.x2&&b<=this.y2&&d>=this.y1;return e}},{key:"_query",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function c(d,e,f,g,h){var i,j,k,a;return regeneratorRuntime.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return b.next=2,this.init();case 2:if(this.whetherOverlap(d,e,f,g)){b.next=6;break}return b.abrupt("return",[]);case 6:if(!this.flag){b.next=12;break}return b.next=9,this.__query(h);case 9:return b.abrupt("return",b.sent);case 12:if(!this.leftSon){b.next=22;break}return b.next=15,Promise.all([this.leftSon._query(d,e,f,g,h),this.rightSon._query(d,e,f,g,h)]);case 15:return i=b.sent,j=_slicedToArray(i,2),k=j[0],a=j[1],b.abrupt("return",k.concat(a));case 22:return b.abrupt("return",[]);case 23:case"end":return b.stop();}},c,this)}));return function _query(){return a.apply(this,arguments)}}()},{key:"query",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b,c,d,e,f){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this.init();case 2:if(!this.father){a.next=8;break}return a.next=5,this.father.query(b,c,d,e,f);case 5:return a.abrupt("return",a.sent);case 8:return a.next=10,this._query(b,c,d,e,f);case 10:return a.abrupt("return",a.sent);case 11:case"end":return a.stop();}},a,this)}));return function query(){return a.apply(this,arguments)}}()},{key:"findAncestor",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(this.father){a.next=4;break}return a.abrupt("return",this);case 4:return a.next=6,this.father.findAncestor();case 6:return a.abrupt("return",a.sent);case 7:case"end":return a.stop();}},a,this)}));return function findAncestor(){return a.apply(this,arguments)}}()}]),b}(TimeLine);function createTree(a,b){return new a(-edgeSize/2,-edgeSize/2,edgeSize/2-1,edgeSize/2-1,null,b)}var isNode=!1;"object"===("undefined"==typeof process?"undefined":_typeof(process))&&"object"===_typeof(process.versions)&&"undefined"!=typeof process.versions.node&&(isNode=!0),isNode&&(module.exports={edgeSize:edgeSize,TreeNode:TreeNode,createTree:createTree});